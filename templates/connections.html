<!DOCTYPE html>
<html>
<head>
    <title>Połączenia API</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <h1>Zarządzaj połączeniami API</h1>

        <!-- Sekcja Google Fit -->
        <div class="connection-card">
            <h2>Google Fit</h2>
            <button onclick="initGoogleFitAuth()" id="google-fit-btn">
                Autoryzuj z Google Fit
            </button>
            <div id="status-message"></div>
        </div>

    </div>

    <script>
async function initGoogleFitAuth() {
    try {
        const response = await fetch('/api-connections/google-fit/auth', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Błąd serwera');
        }

        const data = await response.json();
        localStorage.setItem('oauth_state', data.state);
        window.location.href = data.auth_url;

    } catch (error) {
        showError(`Błąd: ${error.message}`);
    }
}

async function loadConnections() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api-connections/', {
            headers: {
                'Authorization': `Bearer ${token}`  // Dodaj nagłówek
            }
        });
        if (!response.ok) throw new Error('Błąd ładowania danych');

        const connections = await response.json();
        const btn = document.getElementById('google-fit-btn');

        connections.forEach(conn => {
            if (conn.provider === 'google_fit') {
                btn.innerHTML = conn.is_active
                    ? 'Połączono z Google Fit <span class="status-dot active"></span>'
                    : 'Autoryzuj z Google Fit <span class="status-dot inactive"></span>';
            }
        });

    } catch (error) {
        showError('Nie udało się załadować połączeń'+ error.message);
    }
}

function showError(message) {
    const errorDiv = document.getElementById('status-message');
    errorDiv.innerHTML = `<div class="alert error">${message}</div>`;
    setTimeout(() => errorDiv.innerHTML = '', 5000);
}

// Inicjalizacja po załadowaniu strony
window.addEventListener('load', () => {
    loadConnections();
});
</script>
</body>
</html>